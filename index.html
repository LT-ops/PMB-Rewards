<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PMT & PMB Rewards Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0a0f1a 0%, #1a1f3a 100%);
      color: #e8edf3;
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 32px;
      padding: 24px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .subtitle {
      color: #94a3b8;
      font-size: 14px;
      margin-top: 8px;
    }
    .card {
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }
    .input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    input {
      flex: 1;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(15, 23, 42, 0.8);
      color: #e8edf3;
      font-size: 15px;
      transition: all 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    button {
      padding: 14px 32px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-size: 15px;
    }
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .button-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .secondary-btn {
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.3);
      font-size: 14px;
      padding: 10px 20px;
    }
    .share-btn {
      background: linear-gradient(135deg, #10b981, #059669);
    }
    .error {
      color: #ef4444;
      font-weight: 600;
      margin: 12px 0;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 8px;
      display: none;
    }
    .loading {
      color: #3b82f6;
      margin: 12px 0;
      display: none;
    }
    .loading-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 14px;
    }
    .loading-step.complete {
      color: #10b981;
    }
    .loading-step.active {
      color: #3b82f6;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .token-section {
      margin-bottom: 32px;
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(139, 92, 246, 0.05));
    }
    .token-section h2 {
      margin: 0 0 20px;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .token-logo {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
    }
    .balance-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .balance-label {
      font-size: 13px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .balance-value {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
    }
    .history-badge {
      display: inline-block;
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      margin-top: 8px;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .history-badge.negative {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }
    .aggregate-card {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .apy-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .apy-value {
      font-size: 36px;
      font-weight: 700;
      color: #10b981;
    }
    .reflections-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .reward-card {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .reward-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.3);
    }
    .token-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .token-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #3b82f6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }
    .token-name {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
    }
    .token-address {
      font-size: 11px;
      color: #64748b;
      font-family: monospace;
      margin-top: 4px;
    }
    .reflection-amount {
      font-size: 24px;
      font-weight: 700;
      color: #10b981;
      margin-top: 12px;
    }
    .reflection-label {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
    }
    .usd-value {
      font-size: 14px;
      color: #3b82f6;
      margin-top: 4px;
    }
    .price-status {
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
    }
    .price-warning {
      color: #f59e0b;
    }
    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin-top: 16px;
      font-size: 13px;
      color: #94a3b8;
    }
    .warning-box {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin: 16px 0;
      font-size: 13px;
      color: #fbbf24;
    }
    .status-text {
      font-size: 12px;
      color: #64748b;
      margin-top: 8px;
    }
    .refresh-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #64748b;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .auto-refresh {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    @media (max-width: 640px) {
      h1 { font-size: 24px; }
      .input-group { flex-direction: column; }
      .reflections-grid { grid-template-columns: 1fr; }
      .button-group { flex-direction: column; }
      .button-group button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>PMT & PMB Rewards Tracker</h1>
      <div class="subtitle">Track your rewards across both tokens on PulseChain</div>
      <div class="subtitle" style="margin-top: 4px; font-size: 12px;">Enter any wallet address ‚Ä¢ No connection required</div>
    </div>

    <div class="card">
      <div class="input-group">
        <input 
          id="walletInput" 
          type="text" 
          placeholder="Enter wallet address (0x...)" 
          autocomplete="off"
        />
        <button id="checkBtn">Check All Rewards</button>
      </div>

      <div id="buttonGroup" class="button-group" style="display: none;">
        <button id="refreshBtn" class="secondary-btn">üîÑ Refresh Prices</button>
        <button id="shareBtn" class="secondary-btn share-btn">üîó Share Results</button>
      </div>

      <div id="error" class="error"></div>
      <div id="loading" class="loading"></div>
    </div>

    <!-- PMT Section -->
    <div id="pmtSection" style="display: none;" class="token-section">
      <h2>
        <div class="token-logo">üíé</div>
        <div>
          <div>PMT Token</div>
          <div style="font-size: 14px; font-weight: 400; color: #94a3b8; margin-top: 4px;">WBTC Rewards</div>
        </div>
      </h2>

      <div class="balance-card">
        <div class="balance-label">Your PMT Holdings</div>
        <div class="balance-value" id="pmtBalance">‚Äî</div>
        <div id="pmtHistory"></div>
      </div>

      <div id="pmtApySection" style="display: none;">
        <div class="apy-card">
          <div class="balance-label">Estimated APY</div>
          <div class="apy-value" id="pmtApy">‚Äî</div>
          <div class="status-text" id="pmtApyNote">Based on your 30-day rewards average</div>
        </div>
      </div>

      <div id="pmtAggregateSection" style="display: none;">
        <div class="aggregate-card">
          <div class="balance-label">Total PMT Rewards Value</div>
          <div class="balance-value" id="pmtAggregateReflections">‚Äî</div>
          <div class="status-text">Estimated total in USD (market prices may vary)</div>
        </div>
      </div>

      <h3 style="margin: 0 0 12px; color: #e8edf3;">Pending Rewards</h3>
      <div class="reflections-grid" id="pmtRewardsGrid"></div>

      <div class="info-box">
        üí° <strong>How to claim:</strong> Rewards are automatically distributed when you sell PMT. You can also try sending 0 PMT to yourself to trigger distribution, or call <code>claimYield()</code> manually (requires gas). If pending is 0, rewards may have been auto-claimed to your wallet.
      </div>

      <div class="refresh-info">
        <div id="pmtLastUpdate">Last updated: ‚Äî</div>
        <div class="auto-refresh" id="pmtAutoRefresh" style="display: none;">
          Auto-refresh in: <span id="pmtCountdown">60</span>s
        </div>
      </div>
    </div>

    <!-- PMB Section -->
    <div id="pmbSection" style="display: none;" class="token-section">
      <h2>
        <div class="token-logo" style="background: linear-gradient(135deg, #10b981, #3b82f6);">üî∑</div>
        <div>
          <div>PMB Token</div>
          <div style="font-size: 14px; font-weight: 400; color: #94a3b8; margin-top: 4px;">PCOCK & PHEN Rewards</div>
        </div>
      </h2>

      <div class="balance-card">
        <div class="balance-label">Your PMB Holdings</div>
        <div class="balance-value" id="pmbBalance">‚Äî</div>
        <div id="pmbHistory"></div>
      </div>

      <div id="pmbApySection" style="display: none;">
        <div class="apy-card">
          <div class="balance-label">Estimated APY</div>
          <div class="apy-value" id="pmbApy">‚Äî</div>
          <div class="status-text" id="pmbApyNote">Based on your 30-day rewards average</div>
        </div>
      </div>

      <div id="pmbAggregateSection" style="display: none;">
        <div class="aggregate-card">
          <div class="balance-label">Total PMB Reflections Value</div>
          <div class="balance-value" id="pmbAggregateReflections">‚Äî</div>
          <div class="status-text">Estimated total in USD across all yield tokens (market prices may vary)</div>
        </div>
      </div>

      <h3 style="margin: 0 0 12px; color: #e8edf3;">Pending Reflections by Token</h3>
      <div class="reflections-grid" id="pmbReflectionsGrid"></div>

      <div class="info-box">
        üí° <strong>How to claim:</strong> Reflections are automatically distributed when you sell PMB. You can also try sending 0 PMB to yourself to trigger distribution, or call <code>claimYield()</code> manually (requires gas). If pending is 0, rewards may have been auto-claimed to your wallet.
      </div>

      <div class="refresh-info">
        <div id="pmbLastUpdate">Last updated: ‚Äî</div>
        <div class="auto-refresh" id="pmbAutoRefresh" style="display: none;">
          Auto-refresh in: <span id="pmbCountdown">60</span>s
        </div>
      </div>
    </div>
  </div>

  <script>
  (async function() {
    const RPCS = [
      "https://rpc.pulsechain.com",
      "https://pulsechain-rpc.publicnode.com",
      "https://rpc-pulsechain.g4mm4.io",
      "https://rpc.mainnet.pulsechain.com"
    ];
    const NETWORK = { chainId: 369, name: "PulseChain" };
    
    const PMT_CONTRACT = "0x56d554364071e86dd9520ebb3a96dea9cacd4a60";
    const PMB_CONTRACT = "0x2f9a1a04d5894494616ec170828e32e2bc04af63";
    
    const PMT_YIELD_TOKENS = [
      {
        index: 0,
        addr: "0x2260fac5e5542a773aa44fbcfedf7c193bc2c599",
        name: "WBTC",
        color: "#f7931a",
        pairAddr: "0x46e27ea3a035ffc9e6d6d56702ce3d208ff1e58c" // WBTC/WPLS pair on PulseX
      }
    ];

    const PMB_YIELD_TOKENS = [
      {
        index: 0,
        addr: "0xc10a4ed9b4042222d69ff0b374eddd47ed90fc1f",
        name: "PCOCK",
        color: "#3b82f6",
        pairAddr: "0xc10a4ed9b4042222d69ff0b374eddd47ed90fc1f" // Use token addr for now
      },
      {
        index: 1,
        addr: "0xfde3255fb043ea55f9d8635c5e7ff18770a6a810",
        name: "PHEN",
        color: "#8b5cf6",
        pairAddr: "0xfde3255fb043ea55f9d8635c5e7ff18770a6a810" // Use token addr for now
      }
    ];

    const TOKEN_ABI = [
      "function balanceOf(address account) view returns (uint256)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function pendingYields(address account, uint256 tokenIndex) view returns (uint256)",
      "function isExcludedFromReflections(address) view returns (bool)"
    ];

    const ERC20_ABI = [
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)"
    ];

    const $ = id => document.getElementById(id);
    
    let currentAddress = '';
    let priceCache = {};
    let autoRefreshInterval = null;
    let countdownInterval = null;
    let countdown = 60;

    // Load from URL params if present
    const urlParams = new URLSearchParams(window.location.search);
    const addressParam = urlParams.get('address');
    if (addressParam && ethers.utils.isAddress(addressParam)) {
      $('walletInput').value = addressParam;
      setTimeout(() => checkRewards(), 500);
    }

    function formatNumber(num, decimals = 2) {
      if (num === 0) return "0.00";
      const parts = num.toFixed(decimals).split(".");
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return parts.join(".");
    }

    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      return `${hours}h ago`;
    }

    async function safeCall(promise, fallback = null) {
      try {
        return await promise;
      } catch (error) {
        console.warn("Call failed:", error.message);
        return fallback;
      }
    }

    async function getProvider() {
      for (const rpc of RPCS) {
        try {
          const provider = new ethers.providers.JsonRpcProvider(rpc, NETWORK);
          await provider.getBlockNumber();
          console.log("Connected to:", rpc);
          return provider;
        } catch (e) {
          console.warn(`RPC ${rpc} failed:`, e.message);
        }
      }
      throw new Error("All RPCs failed. Please try again later.");
    }

    async function getDexPrice(tokenAddr, pairAddr, useCache = true) {
      const cacheKey = tokenAddr.toLowerCase();
      const now = Date.now();
      
      // Check cache (5 minute TTL)
      if (useCache && priceCache[cacheKey] && (now - priceCache[cacheKey].timestamp < 5 * 60 * 1000)) {
        console.log(`Using cached price for ${tokenAddr}`);
        return priceCache[cacheKey];
      }

      // Try pair address first for PulseChain tokens
      const queryAddr = pairAddr || tokenAddr;

      try {
        const response = await fetch(`https://api.dexscreener.com/latest/dex/pairs/pulsechain/${queryAddr}`);
        const data = await response.json();
        if (data.pair && data.pair.priceUsd) {
          const price = parseFloat(data.pair.priceUsd) || 0;
          priceCache[cacheKey] = {
            price,
            timestamp: now,
            source: 'dexscreener'
          };
          console.log(`Price for ${tokenAddr}: ${price}`);
          return priceCache[cacheKey];
        }
        
        // Fallback to token search
        const tokenResponse = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${tokenAddr}`);
        const tokenData = await tokenResponse.json();
        if (tokenData.pairs && tokenData.pairs[0]) {
          const price = parseFloat(tokenData.pairs[0].priceUsd) || 0;
          priceCache[cacheKey] = {
            price,
            timestamp: now,
            source: 'dexscreener'
          };
          console.log(`Price for ${tokenAddr} (fallback): ${price}`);
          return priceCache[cacheKey];
        }
      } catch (e) {
        console.warn('Failed to fetch DEX price for ' + tokenAddr + ':', e);
      }
      
      // Return cached if available, even if stale
      if (priceCache[cacheKey]) {
        priceCache[cacheKey].stale = true;
        return priceCache[cacheKey];
      }
      
      return { price: 0, timestamp: now, source: 'unavailable' };
    }

    function saveHistory(address, tokenSymbol, balance, rewards) {
      const key = `history_${address.toLowerCase()}_${tokenSymbol}`;
      const history = JSON.parse(localStorage.getItem(key) || '[]');
      
      history.push({
        timestamp: Date.now(),
        balance,
        rewards
      });
      
      // Keep last 30 entries
      if (history.length > 30) history.shift();
      
      localStorage.setItem(key, JSON.stringify(history));
    }

    function getHistory(address, tokenSymbol) {
      const key = `history_${address.toLowerCase()}_${tokenSymbol}`;
      return JSON.parse(localStorage.getItem(key) || '[]');
    }

    function calculateAPY(address, tokenSymbol, currentBalance, rewardsUsd) {
      const history = getHistory(address, tokenSymbol);
      if (history.length < 2) return null;

      // Get 30-day average if available
      const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
      const oldEntries = history.filter(h => h.timestamp >= thirtyDaysAgo);
      
      if (oldEntries.length === 0) return null;

      const totalRewards = rewardsUsd;
      const avgBalance = currentBalance;
      
      if (avgBalance === 0) return null;

      // Estimate based on current rewards
      const dailyRewards = totalRewards;
      const yearlyRewards = dailyRewards * 365;
      const balanceUsd = avgBalance; // Simplified - would need token price
      
      if (balanceUsd === 0) return null;
      
      const apy = (yearlyRewards / balanceUsd) * 100;
      return apy;
    }

    function showHistory(address, tokenSymbol, currentBalance, historyEl) {
      const history = getHistory(address, tokenSymbol);
      if (history.length < 2) return;

      const previous = history[history.length - 2];
      const change = currentBalance - previous.balance;
      const percentChange = (change / previous.balance) * 100;

      if (change !== 0) {
        const badge = document.createElement('div');
        badge.className = change > 0 ? 'history-badge' : 'history-badge negative';
        badge.textContent = `${change > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(percentChange).toFixed(2)}% since last check`;
        historyEl.appendChild(badge);
      }
    }

    function updateLoadingStep(step, status) {
      const loading = $('loading');
      const stepId = `step-${step}`;
      let stepEl = document.getElementById(stepId);
      
      if (!stepEl) {
        stepEl = document.createElement('div');
        stepEl.id = stepId;
        stepEl.className = 'loading-step';
        loading.appendChild(stepEl);
      }

      if (status === 'complete') {
        stepEl.className = 'loading-step complete';
        stepEl.innerHTML = `‚úì ${step}`;
      } else if (status === 'active') {
        stepEl.className = 'loading-step active';
        stepEl.innerHTML = `<div class="spinner"></div> ${step}`;
      } else {
        stepEl.className = 'loading-step';
        stepEl.innerHTML = `‚è≥ ${step}`;
      }
    }

    async function checkTokenRewards(provider, address, contractAddr, yieldTokens, balanceEl, aggregateEl, aggregateSectionEl, gridEl, apyEl, apySectionEl, apyNoteEl, historyEl, lastUpdateEl, tokenSymbol, refreshPrices = false) {
      const contract = new ethers.Contract(contractAddr, TOKEN_ABI, provider);
      
      const [balance, decimals, symbol] = await Promise.all([
        safeCall(contract.balanceOf(address), ethers.BigNumber.from(0)),
        safeCall(contract.decimals(), 18),
        safeCall(contract.symbol(), tokenSymbol)
      ]);

      const balanceFormatted = parseFloat(ethers.utils.formatUnits(balance, decimals));
      balanceEl.textContent = `${formatNumber(balanceFormatted, 4)} ${symbol}`;

      // Show history
      showHistory(address, symbol, balanceFormatted, historyEl);

      const isExcluded = await safeCall(contract.isExcludedFromReflections(address), null);
      if (isExcluded === true) {
        gridEl.innerHTML = '<div class="warning-box">‚ö†Ô∏è This address is excluded from receiving reflections.</div>';
        return;
      }

      let totalUsd = 0;
      gridEl.innerHTML = '';

      for (let j = 0; j < yieldTokens.length; j++) {
        const item = yieldTokens[j];
        const tokenAddr = item.addr.toLowerCase();

        try {
          const pending = await contract.pendingYields(address, item.index);

          const tokenContract = new ethers.Contract(tokenAddr, ERC20_ABI, provider);
          const [tokenDecimals, tokenSymbol] = await Promise.all([
            safeCall(tokenContract.decimals(), 18),
            safeCall(tokenContract.symbol(), item.name)
          ]);

          const pendingFormatted = parseFloat(ethers.utils.formatUnits(pending, tokenDecimals));
          const priceData = await getDexPrice(tokenAddr, item.pairAddr, !refreshPrices);
          const usdValue = pendingFormatted * priceData.price;
          totalUsd += usdValue;

          const card = document.createElement("div");
          card.className = "reward-card";
          
          let priceStatus = '';
          if (priceData.stale) {
            priceStatus = `<div class="price-status price-warning">‚ö†Ô∏è Price data is ${formatTimeAgo(priceData.timestamp)}</div>`;
          } else if (priceData.source === 'unavailable') {
            priceStatus = `<div class="price-status price-warning">‚ö†Ô∏è Price unavailable</div>`;
          } else {
            priceStatus = `<div class="price-status">Updated ${formatTimeAgo(priceData.timestamp)}</div>`;
          }

          card.innerHTML = `
            <div class="token-header">
              <div class="token-icon" style="background: linear-gradient(135deg, ${item.color}, #10b981)">
                ${item.name[0]}
              </div>
              <div>
                <div class="token-name">${item.name}</div>
                <div class="token-address">${tokenAddr.slice(0, 10)}...${tokenAddr.slice(-8)}</div>
              </div>
            </div>
            <div class="reflection-amount">${formatNumber(pendingFormatted, 8)} ${tokenSymbol}</div>
            <div class="reflection-label">Pending (Unclaimed) Rewards</div>
            <div class="usd-value">‚âà ${formatNumber(usdValue, 2)} USD</div>
            ${priceStatus}
          `;
          gridEl.appendChild(card);
        } catch (tokenError) {
          console.error(`Failed to get pending for token ${item.index}:`, tokenError.message);
        }
      }

      // Save history
      saveHistory(address, symbol, balanceFormatted, totalUsd);

      // Calculate and show APY
      const apy = calculateAPY(address, symbol, balanceFormatted, totalUsd);
      if (apy !== null && apy > 0) {
        apyEl.textContent = `${formatNumber(apy, 2)}%`;
        apySectionEl.style.display = "block";
        
        const history = getHistory(address, symbol);
        if (history.length >= 7) {
          apyNoteEl.textContent = "Based on your 30-day rewards average";
        } else {
          apyNoteEl.textContent = `Based on ${history.length} data points ‚Ä¢ Check more often for accurate APY`;
        }
      }

      if (totalUsd > 0) {
        aggregateEl.textContent = `‚âà ${formatNumber(totalUsd, 2)} USD`;
        aggregateSectionEl.style.display = "block";
      }

      // Update last updated time
      lastUpdateEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    }

    async function checkRewards(refreshPrices = false) {
      const $wallet = $('walletInput');
      const $check = $('checkBtn');
      const $error = $('error');
      const $loading = $('loading');
      const $buttonGroup = $('buttonGroup');

      $error.textContent = "";
      $error.style.display = "none";
      $loading.style.display = "block";
      $loading.innerHTML = '';
      $check.disabled = true;

      $("pmtSection").style.display = "none";
      $("pmbSection").style.display = "none";
      $("pmtAggregateSection").style.display = "none";
      $("pmbAggregateSection").style.display = "none";
      $("pmtApySection").style.display = "none";
      $("pmbApySection").style.display = "none";
      $("pmtHistory").innerHTML = '';
      $("pmbHistory").innerHTML = '';

      const address = $wallet.value.trim();
      currentAddress = address;
      
      if (!ethers.utils.isAddress(address)) {
        $error.textContent = "Please enter a valid wallet address";
        $error.style.display = "block";
        $loading.style.display = "none";
        $check.disabled = false;
        return;
      }

      try {
        updateLoadingStep('Connecting to PulseChain', 'active');
        const provider = await getProvider();
        updateLoadingStep('Connecting to PulseChain', 'complete');

        updateLoadingStep('Fetching PMT data', 'active');
        await checkTokenRewards(
          provider, 
          address, 
          PMT_CONTRACT, 
          PMT_YIELD_TOKENS,
          $("pmtBalance"),
          $("pmtAggregateReflections"),
          $("pmtAggregateSection"),
          $("pmtRewardsGrid"),
          $("pmtApy"),
          $("pmtApySection"),
          $("pmtApyNote"),
          $("pmtHistory"),
          $("pmtLastUpdate"),
          "PMT",
          refreshPrices
        );
        updateLoadingStep('Fetching PMT data', 'complete');
        $("pmtSection").style.display = "block";

        updateLoadingStep('Fetching PMB data', 'active');
        await checkTokenRewards(
          provider, 
          address, 
          PMB_CONTRACT, 
          PMB_YIELD_TOKENS,
          $("pmbBalance"),
          $("pmbAggregateReflections"),
          $("pmbAggregateSection"),
          $("pmbReflectionsGrid"),
          $("pmbApy"),
          $("pmbApySection"),
          $("pmbApyNote"),
          $("pmbHistory"),
          $("pmbLastUpdate"),
          "PMB",
          refreshPrices
        );
        updateLoadingStep('Fetching PMB data', 'complete');
        $("pmbSection").style.display = "block";

        // Show action buttons
        $buttonGroup.style.display = "flex";

        // Start auto-refresh
        startAutoRefresh();

      } catch (error) {
        console.error(error);
        $error.textContent = `Error: ${error.message}`;
        $error.style.display = "block";
      } finally {
        $loading.style.display = "none";
        $check.disabled = false;
      }
    }

    function startAutoRefresh() {
      stopAutoRefresh();
      
      countdown = 60;
      $("pmtAutoRefresh").style.display = "flex";
      $("pmbAutoRefresh").style.display = "flex";
      
      countdownInterval = setInterval(() => {
        countdown--;
        $("pmtCountdown").textContent = countdown;
        $("pmbCountdown").textContent = countdown;
        
        if (countdown <= 0) {
          refreshPrices();
        }
      }, 1000);
    }

    function stopAutoRefresh() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      $("pmtAutoRefresh").style.display = "none";
      $("pmbAutoRefresh").style.display = "none";
    }

    async function refreshPrices() {
      if (!currentAddress) return;
      
      $("refreshBtn").disabled = true;
      $("refreshBtn").textContent = "üîÑ Refreshing...";
      
      try {
        await checkRewards(true);
      } finally {
        $("refreshBtn").disabled = false;
        $("refreshBtn").textContent = "üîÑ Refresh Prices";
      }
    }

    function shareResults() {
      const address = currentAddress || $("walletInput").value.trim();
      if (!ethers.utils.isAddress(address)) {
        alert("Please check rewards first");
        return;
      }

      const url = `${window.location.origin}${window.location.pathname}?address=${address}`;
      
      if (navigator.share) {
        navigator.share({
          title: 'My PMT & PMB Rewards',
          text: 'Check out my token rewards!',
          url: url
        }).catch(err => console.log('Share failed:', err));
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
          const originalText = $("shareBtn").textContent;
          $("shareBtn").textContent = "‚úì Link Copied!";
          setTimeout(() => {
            $("shareBtn").textContent = originalText;
          }, 2000);
        });
      }
    }

    $("checkBtn").addEventListener("click", () => checkRewards(false));
    $("refreshBtn").addEventListener("click", refreshPrices);
    $("shareBtn").addEventListener("click", shareResults);
    $("walletInput").addEventListener("keypress", (e) => {
      if (e.key === "Enter") checkRewards(false);
    });

    // Stop auto-refresh when user leaves page
    window.addEventListener('beforeunload', stopAutoRefresh);
  })();
  </script>
</body>
</html>
